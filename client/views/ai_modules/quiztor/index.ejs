<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quiztor - AI Soru Üretici - Learnity</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/styles/ai_modules/quiztor/style.css">
    <script src="https://kit.fontawesome.com/c4254e24a8.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
</head>
<body class="quiztor-page">

    <!-- Header Navigation -->
    <div class="header-container">
        <header class="navbar">
            <div class="logo">
                <a href="/">
                    <img src="images/logo.png" alt="Learnity Logo">
                    <span class="logo-text">Learnity</span>
                </a>
            </div>
            
            <nav class="breadcrumb">
                <a href="/dashboard">Dashboard</a>
                <span class="separator">></span>
                <a href="/ai_modules">AI Modülleri</a>
                <span class="separator">></span>
                <span class="current">Quiztor - AI Soru Üretici</span>
            </nav>
        </header>
    </div>

    <!-- Main Container -->
    <div class="container">
        <!-- Content Wrapper -->
        <div class="content-wrapper">
            <!-- Sol Taraf - Ana İçerik -->
            <div class="main-content">
                <!-- Input Section - Soru Üretme -->
                <div class="input-section" id="input-section">
                    <!-- Konu Belirleme Kartı -->
                    <div class="topic-card">
                        <h2 class="topic-title">Konu Belirleyin</h2>
                        <p class="topic-subtitle">Hangi konu hakkında soru oluşturmak istiyorsunuz?</p>
                        
                        <div class="topic-input-container">
                            <textarea 
                                id="subject-input" 
                                class="topic-textarea"
                                placeholder="Örnek: Python programlama dili temel kavramları, Osmanlı İmparatorluğu'nun kuruluş dönemi, Matematik türev konusu..."
                                rows="4"
                            ></textarea>
                        </div>
                    </div>

                    <!-- Ayarlar Kartı -->
                    <div class="settings-card">
                        <div class="settings-row">
                            <div class="setting-group">
                                <h4>Zorluk Seviyesi</h4>
                                <div class="radio-group">
                                    <label class="radio-option">
                                        <input type="radio" name="difficulty-level" value="easy" checked>
                                        <span class="radio-custom"></span>
                                        <div class="radio-content">
                                            <strong>Kolay</strong>
                                            <span>Temel seviye sorular</span>
                                        </div>
                                    </label>
                                    <label class="radio-option">
                                        <input type="radio" name="difficulty-level" value="normal">
                                        <span class="radio-custom"></span>
                                        <div class="radio-content">
                                            <strong>Orta</strong>
                                            <span>Orta seviye sorular</span>
                                        </div>
                                    </label>
                                    <label class="radio-option">
                                        <input type="radio" name="difficulty-level" value="hard">
                                        <span class="radio-custom"></span>
                                        <div class="radio-content">
                                            <strong>Zor</strong>
                                            <span>İleri seviye sorular</span>
                                        </div>
                                    </label>
                                </div>
                            </div>

                            <div class="setting-group">
                                <h4>Soru Sayısı</h4>
                                <div class="select-group">
                                    <select id="question-count" class="custom-select">
                                        <option value="1">1 Soru</option>
                                        <option value="2">2 Soru</option>
                                        <option value="3" selected>3 Soru</option>
                                        <option value="4">4 Soru</option>
                                        <option value="5">5 Soru</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <div class="generate-btn-container">
                            <button id="generate-questions-btn" class="generate-btn">
                                <i class="fas fa-magic"></i>
                                Sorular Oluştur
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Quiz Section - Test Çözme Ekranı -->
                <div class="quiz-section" id="quiz-section" style="display: none;">
                    <div class="quiz-header">
                        <h2>Test Çözme</h2>
                        <div class="suggested-time">
                            <i class="fas fa-clock"></i>
                            <span>Önerilen Süre: <span id="suggested-time">5 dk</span></span>
                        </div>
                    </div>
                    
                    <div class="questions-container" id="questions-container">
                        <!-- Sorular buraya dinamik olarak eklenecek -->
                    </div>
                    
                    <div class="quiz-actions">
                        <button id="finish-quiz-btn" class="finish-quiz-btn">
                            <i class="fas fa-check"></i>
                            Testi Bitir
                        </button>
                    </div>
                </div>

                <!-- Results Section - Sonuçlar -->
                <div class="results-section" id="results-section" style="display: none;">
                    <div class="results-header">
                        <h2>Test Sonuçları</h2>
                    </div>
                    
                    <div class="score-summary">
                        <div class="score-item correct">
                            <i class="fas fa-check-circle"></i>
                            <span>Doğru: <span id="correct-count">0</span></span>
                        </div>
                        <div class="score-item wrong">
                            <i class="fas fa-times-circle"></i>
                            <span>Yanlış: <span id="wrong-count">0</span></span>
                        </div>
                        <div class="score-item empty">
                            <i class="fas fa-minus-circle"></i>
                            <span>Boş: <span id="empty-count">0</span></span>
                        </div>
                    </div>
                    
                    <div class="detailed-results" id="detailed-results">
                        <!-- Detaylı sonuçlar buraya gelecek -->
                    </div>
                    
                    <div class="results-actions">
                        <button id="new-quiz-btn" class="new-quiz-btn">
                            <i class="fas fa-plus"></i>
                            Yeni Test
                        </button>
                    </div>
                </div>
            </div>

            <!-- Sağ Taraf - Yan Panel -->
            <div class="sidebar">
                <!-- Ders Kategorileri -->
                <div class="categories-section">
                    <div class="categories-header">
                        <h3 class="categories-title">Ders Kategorileri</h3>
                        <p class="categories-subtitle">Sorularınız ders türüne göre gruplandırılmıştır</p>
                    </div>
                    
                    <div class="categories-grid">
                        <div class="category-item matematik">
                            <div class="category-icon">
                                <i class="fas fa-calculator"></i>
                            </div>
                            <div class="category-info">
                                <h4>Matematik</h4>
                                <span class="category-count">7 soru</span>
                            </div>
                        </div>
                        
                        <div class="category-item geometri">
                            <div class="category-icon">
                                <i class="fas fa-shapes"></i>
                            </div>
                            <div class="category-info">
                                <h4>Geometri</h4>
                                <span class="category-count">3 soru</span>
                            </div>
                        </div>
                        
                        <div class="category-item fizik">
                            <div class="category-icon">
                                <i class="fas fa-atom"></i>
                            </div>
                            <div class="category-info">
                                <h4>Fizik</h4>
                                <span class="category-count">5 soru</span>
                            </div>
                        </div>
                        
                        <div class="category-item kimya">
                            <div class="category-icon">
                                <i class="fas fa-flask"></i>
                            </div>
                            <div class="category-info">
                                <h4>Kimya</h4>
                                <span class="category-count">2 soru</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- İstatistikler -->
                <div class="stats-section">
                    <div class="stats-header">
                        <h3 class="stats-title">
                            <i class="fas fa-chart-bar"></i>
                            Kullanım İstatistikleri
                        </h3>
                    </div>
                    
                    <div class="stats-grid">
                        <div class="stat-item">
                            <div class="stat-icon total">
                                <i class="fas fa-question-circle"></i>
                            </div>
                            <div class="stat-info">
                                <span class="stat-number" id="total-questions">0</span>
                                <span class="stat-label">Oluşturulan Soru</span>
                            </div>
                        </div>
                        
                        <div class="stat-item">
                            <div class="stat-icon correct">
                                <i class="fas fa-check-circle"></i>
                            </div>
                            <div class="stat-info">
                                <span class="stat-number" id="correct-answers">0</span>
                                <span class="stat-label">Doğru Cevap</span>
                            </div>
                        </div>
                        
                        <div class="stat-item">
                            <div class="stat-icon wrong">
                                <i class="fas fa-times-circle"></i>
                            </div>
                            <div class="stat-info">
                                <span class="stat-number" id="wrong-answers">0</span>
                                <span class="stat-label">Yanlış Cevap</span>
                            </div>
                        </div>
                        
                        <div class="stat-item">
                            <div class="stat-icon empty">
                                <i class="fas fa-minus-circle"></i>
                            </div>
                            <div class="stat-info">
                                <span class="stat-number" id="empty-answers">0</span>
                                <span class="stat-label">Boş Bırakılan</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let currentQuestions = [];
        let userAnswers = {};
        let quizStats = JSON.parse(localStorage.getItem('quiztor_stats') || '{"totalQuestions": 0, "correctAnswers": 0, "wrongAnswers": 0, "emptyAnswers": 0}');

        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            updateStatsDisplay();
            
            // Event listeners
            document.getElementById('generate-questions-btn').addEventListener('click', generateQuestions);
            document.getElementById('finish-quiz-btn').addEventListener('click', finishQuiz);
            document.getElementById('new-quiz-btn').addEventListener('click', startNewQuiz);
        });

        // Generate questions
        async function generateQuestions() {
            const subject = document.getElementById('subject-input').value.trim();
            const type = document.querySelector('input[name="difficulty-level"]:checked').value;
            const piece = parseInt(document.getElementById('question-count').value);

            if (!subject) {
                alert('Lütfen bir konu girin.');
                return;
            }

            const generateBtn = document.getElementById('generate-questions-btn');
            generateBtn.disabled = true;
            generateBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Sorular Oluşturuluyor...';

            try {
                const response = await axios.post('/gemini/createQuestion', {
                    subject: subject,
                    type: type,
                    piece: piece
                });

                if (response.data.success) {
                    currentQuestions = response.data.questions;
                    userAnswers = {};
                    
                    // Update suggested time if provided
                    if (response.data.suggestedTime) {
                        document.getElementById('suggested-time').textContent = response.data.suggestedTime;
                    }
                    
                    displayQuiz();
                } else {
                    alert('Soru oluşturulurken hata oluştu: ' + (response.data.error || 'Bilinmeyen hata'));
                }
            } catch (error) {
                console.error('API Error:', error);
                alert('Soru oluşturulurken hata oluştu. Lütfen tekrar deneyin.');
            } finally {
                generateBtn.disabled = false;
                generateBtn.innerHTML = '<i class="fas fa-magic"></i> Sorular Oluştur';
            }
        }

        // Display quiz
        function displayQuiz() {
            document.getElementById('input-section').style.display = 'none';
            document.getElementById('quiz-section').style.display = 'block';
            document.getElementById('results-section').style.display = 'none';

            const container = document.getElementById('questions-container');
            container.innerHTML = '';

            currentQuestions.forEach((question, index) => {
                const questionDiv = document.createElement('div');
                questionDiv.className = 'question-item';
                questionDiv.innerHTML = `
                    <div class="question-header">
                        <span class="question-number">Soru ${index + 1}</span>
                    </div>
                    <div class="question-text">${question.question}</div>
                    <div class="options-container">
                        ${question.options.map((option, optIndex) => `
                            <label class="option-label">
                                <input type="radio" name="question-${index}" value="${optIndex}">
                                <span class="option-text">${option}</span>
                            </label>
                        `).join('')}
                    </div>
                    <div class="question-actions">
                        <button class="skip-btn" onclick="skipQuestion(${index})">
                            <i class="fas fa-forward"></i>
                            Boş Bırak
                        </button>
                    </div>
                `;
                container.appendChild(questionDiv);
            });
        }

        // Skip question
        function skipQuestion(questionIndex) {
            const radioButtons = document.querySelectorAll(`input[name="question-${questionIndex}"]`);
            radioButtons.forEach(radio => radio.checked = false);
            userAnswers[questionIndex] = null;
        }

        // Finish quiz
        function finishQuiz() {
            // Collect answers
            currentQuestions.forEach((question, index) => {
                const selectedOption = document.querySelector(`input[name="question-${index}"]:checked`);
                userAnswers[index] = selectedOption ? parseInt(selectedOption.value) : null;
            });

            // Calculate results
            let correct = 0, wrong = 0, empty = 0;
            
            currentQuestions.forEach((question, index) => {
                const userAnswer = userAnswers[index];
                if (userAnswer === null) {
                    empty++;
                } else if (userAnswer === question.correctAnswer) {
                    correct++;
                } else {
                    wrong++;
                }
            });

            // Update stats
            quizStats.totalQuestions += currentQuestions.length;
            quizStats.correctAnswers += correct;
            quizStats.wrongAnswers += wrong;
            quizStats.emptyAnswers += empty;
            localStorage.setItem('quiztor_stats', JSON.stringify(quizStats));

            displayResults({ correct, wrong, empty });
        }

        // Display results
        function displayResults(results) {
            document.getElementById('quiz-section').style.display = 'none';
            document.getElementById('results-section').style.display = 'block';

            // Update summary
            document.getElementById('correct-count').textContent = results.correct;
            document.getElementById('wrong-count').textContent = results.wrong;
            document.getElementById('empty-count').textContent = results.empty;

            // Display detailed results
            const detailedResults = document.getElementById('detailed-results');
            detailedResults.innerHTML = '';

            currentQuestions.forEach((question, index) => {
                const userAnswer = userAnswers[index];
                const isCorrect = userAnswer === question.correctAnswer;
                const isEmpty = userAnswer === null;
                
                const resultDiv = document.createElement('div');
                resultDiv.className = `result-item ${isEmpty ? 'empty' : (isCorrect ? 'correct' : 'wrong')}`;
                resultDiv.innerHTML = `
                    <div class="result-header">
                        <span class="result-number">Soru ${index + 1}</span>
                        <span class="result-status">
                            ${isEmpty ? 'Boş Bırakıldı' : (isCorrect ? 'Doğru' : 'Yanlış')}
                        </span>
                    </div>
                    <div class="result-question">${question.question}</div>
                    <div class="result-answers">
                        <div class="correct-answer">
                            <strong>Doğru Cevap:</strong> ${question.options[question.correctAnswer]}
                        </div>
                        ${!isEmpty ? `
                            <div class="user-answer ${isCorrect ? 'correct' : 'wrong'}">
                                <strong>Sizin Cevabınız:</strong> ${question.options[userAnswer]}
                            </div>
                        ` : ''}
                        ${question.explanation ? `
                            <div class="explanation">
                                <strong>Açıklama:</strong> ${question.explanation}
                            </div>
                        ` : ''}
                    </div>
                `;
                detailedResults.appendChild(resultDiv);
            });

            updateStatsDisplay();
        }

        // Start new quiz
        function startNewQuiz() {
            document.getElementById('input-section').style.display = 'block';
            document.getElementById('quiz-section').style.display = 'none';
            document.getElementById('results-section').style.display = 'none';
            
            // Clear form
            document.getElementById('subject-input').value = '';
            document.querySelector('input[name="difficulty-level"][value="easy"]').checked = true;
            document.getElementById('question-count').value = '3';
            
            currentQuestions = [];
            userAnswers = {};
        }

        // Update stats display
        function updateStatsDisplay() {
            document.getElementById('total-questions').textContent = quizStats.totalQuestions;
            document.getElementById('correct-answers').textContent = quizStats.correctAnswers;
            document.getElementById('wrong-answers').textContent = quizStats.wrongAnswers;
            document.getElementById('empty-answers').textContent = quizStats.emptyAnswers;
        }
    </script>

</body>
</html>